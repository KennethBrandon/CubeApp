<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Puzzle Manager</title>
    <script src="js/lib/tailwindcss.js"></script>
    <link rel="stylesheet" href="assets/styles/main.css">

    <!-- Import Map for Three.js (Same as index.html) -->
    <script type="importmap">
        {
            "imports": {
                "three": "./js/lib/three.module.js",
                "three/addons/": "./js/lib/three/addons/",
                "three-mesh-bvh": "./js/lib/three-mesh-bvh.js",
                "three-bvh-csg": "./js/lib/three-bvh-csg.js"
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 p-4 shadow-lg z-10 flex justify-between items-center">
        <h1 class="text-xl font-bold text-green-400">Custom Puzzle Manager</h1>
        <div class="flex gap-4">
            <a href="index.html" class="text-gray-400 hover:text-white text-sm flex items-center gap-2">
                üè† Back to App
            </a>
            <button id="btn-save"
                class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                üíæ Save Draft
            </button>
            <button id="btn-export"
                class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition disabled:opacity-50 disabled:cursor-not-allowed"
                disabled>
                üì§ Export Assets
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar Controls -->
        <aside
            class="w-96 bg-gray-800/50 backdrop-blur border-r border-gray-700 p-4 flex flex-col gap-6 overflow-y-auto">

            <!-- Puzzle List -->
            <!-- Saved Drafts (Local Storage) -->
            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 flex justify-between items-center">
                    Saved Drafts
                    <button id="btn-new-puzzle" class="text-xs text-blue-400 hover:text-blue-300">+ New</button>
                </h2>
                <div id="puzzle-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <p class="text-xs text-gray-500 italic text-center py-4">No drafts yet.</p>
                </div>
            </div>

            <!-- Existing Puzzles (Registry) -->
            <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                <h2 class="text-sm font-bold text-gray-400 uppercase mb-3">
                    Existing Puzzles
                </h2>
                <div id="registry-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                    <p class="text-xs text-gray-500 italic text-center py-4">Loading...</p>
                </div>
            </div>

            <!-- Puzzle Config -->
            <div class="space-y-6">

                <!-- 1. Setup (Always Enabled) -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 flex justify-between items-center">
                        1. Setup
                        <button id="btn-import-config" class="text-xs text-blue-400 hover:text-blue-300">Import
                            Config</button>
                        <input type="file" id="file-input-config" accept=".json" class="hidden">
                    </h2>
                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">Puzzle Name</label>
                        <input type="text" id="puzzle-name" placeholder="My Awesome Puzzle"
                            class="bg-gray-800 border border-gray-600 rounded w-full px-3 py-2 text-sm text-white focus:border-blue-500 outline-none">
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">Upload STL / 3MF</label>
                        <input type="file" id="file-input" accept=".stl,.3mf" class="block w-full text-sm text-gray-400
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-600 file:text-white
                            hover:file:bg-blue-500
                        " />
                    </div>
                </div>

            </div>

            <!-- Sections 2, 3, 4 (Disabled until load) -->
            <div id="config-panel" class="space-y-6 opacity-50 pointer-events-none transition-opacity duration-300">

                <!-- 2. Dimensions & Transform -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3">2. Transform</h2>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">Grid Size (Dimensions)</label>
                        <div class="flex gap-2">
                            <input type="number" id="dim-x" value="2" min="1" max="5"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-center">
                            <span class="text-gray-500 self-center">x</span>
                            <input type="number" id="dim-y" value="2" min="1" max="5"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-center">
                            <span class="text-gray-500 self-center">x</span>
                            <input type="number" id="dim-z" value="2" min="1" max="5"
                                class="w-full bg-gray-800 border border-gray-600 rounded px-2 py-1 text-center">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Rot X:</label>
                            <input type="number" id="val-rotX" value="-90"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-rotX" min="-180" max="180" step="1" value="-90" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Rot Y:</label>
                            <input type="number" id="val-rotY" value="0"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-rotY" min="-180" max="180" step="1" value="0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Rot Z:</label>
                            <input type="number" id="val-rotZ" value="0"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-rotZ" min="-180" max="180" step="1" value="0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Scale:</label>
                            <input type="number" id="val-scale" value="1.0" step="0.01"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-scale" min="0.01" max="100" step="0.01" value="1.0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Offset X:</label>
                            <input type="number" id="val-offX" value="0" step="0.01"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-offX" min="-5" max="5" step="0.01" value="0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Offset Y:</label>
                            <input type="number" id="val-offY" value="0" step="0.01"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-offY" min="-5" max="5" step="0.01" value="0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Offset Z:</label>
                            <input type="number" id="val-offZ" value="0" step="0.01"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-offZ" min="-5" max="5" step="0.01" value="0" class="w-full">
                    </div>
                </div>

                <!-- 3. Material -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3">3. Material</h2>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Roughness:</label>
                            <input type="number" id="val-roughness" value="0.6" step="0.01" min="0" max="1"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-roughness" min="0" max="1" step="0.01" value="0.6" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Metalness:</label>
                            <input type="number" id="val-metalness" value="0.0" step="0.01" min="0" max="1"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-metalness" min="0" max="1" step="0.01" value="0.0" class="w-full">

                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 w-24">Normal Scale:</label>
                            <input type="number" id="val-normalScale" value="0.5" step="0.01" min="0" max="1"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-normalScale" min="0" max="1" step="0.01" value="0.5" class="w-full">

                        <div class="flex items-center gap-2 mt-2">
                            <input type="checkbox" id="chk-sparkle"
                                class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out bg-gray-800 border-gray-600 rounded"
                                checked>
                            <label for="chk-sparkle" class="text-xs text-gray-500">Enable Sparkle Map</label>
                        </div>
                    </div>
                </div>

                <!-- 4. Painting -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3 flex justify-between items-center">
                        4. Paint
                        <button id="btn-import-colors" class="text-xs text-blue-400 hover:text-blue-300">Import
                            Colors</button>
                        <input type="file" id="file-input-colors" accept=".json" class="hidden">
                    </h2>
                    <!-- Color Picker -->
                    <div class="mb-4">
                        <div class="flex gap-2 items-center mb-2">
                            <input type="color" id="color-picker" value="#74C947"
                                class="h-10 w-10 rounded cursor-pointer bg-transparent border-0 p-0">
                            <div class="flex-1">
                                <label class="block text-xs text-gray-500 mb-1">Brush Color</label>
                                <input type="text" id="color-hex" value="#74C947"
                                    class="bg-gray-800 border border-gray-600 rounded px-2 py-1 text-sm w-full font-mono">
                            </div>
                            <button id="btn-add-palette"
                                class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded"
                                title="Add to Palette">
                                ‚ûï
                            </button>
                        </div>

                        <!-- Palette -->
                        <div class="space-y-1">
                            <label class="block text-xs text-gray-500 flex justify-between">
                                Palette
                                <span id="btn-clear-palette"
                                    class="cursor-pointer hover:text-red-400 text-[10px]">Clear</span>
                            </label>
                            <div id="palette-container" class="flex flex-wrap gap-1">
                                <!-- Palette items wil go here -->
                            </div>
                        </div>
                    </div>

                    <!-- Tools -->
                    <div class="flex gap-2 mb-4">
                        <button id="tool-brush"
                            class="flex-1 bg-blue-600 text-white text-xs py-2 rounded border border-blue-500 shadow-lg">
                            üñåÔ∏è Brush
                        </button>
                        <button id="tool-replace"
                            class="flex-1 bg-gray-700 text-white text-xs py-2 rounded border border-gray-600">
                            üîÑ Replace
                        </button>
                        <button id="tool-fill"
                            class="flex-1 bg-gray-700 text-white text-xs py-2 rounded border border-gray-600">
                            Fill All
                        </button>
                    </div>
                    <p id="tool-desc" class="text-[10px] text-gray-400 mt-1 italic mb-2">Click and drag to paint.</p>

                    <div class="mb-2">
                        <div class="flex items-center justify-between">
                            <label class="text-xs text-gray-500 mb-1">Brush Size:</label>
                            <input type="number" id="val-brush" value="0.5" step="0.01"
                                class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                        </div>
                        <input type="range" id="inp-brush" min="0.01" max="5" step="0.01" value="0.5" class="w-full">
                    </div>
                </div>

                <!-- 4. Cut Settings -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3">5. Cut Settings</h2>
                    <div class="space-y-3">
                        <div>
                            <div class="flex items-center justify-between">
                                <label class="text-xs text-gray-500 mb-1">Fillet Radius:</label>
                                <input type="number" id="val-fillet" value="0.14" step="0.01"
                                    class="w-16 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-right">
                            </div>
                            <input type="range" id="inp-fillet" min="0" max="0.5" step="0.01" value="0.14"
                                class="w-full">
                        </div>

                        <!-- Internal Color Settings -->
                        <div class="pt-2 border-t border-gray-700 mt-2">
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="chk-internal-single"
                                    class="form-checkbox h-4 w-4 text-blue-600 transition duration-150 ease-in-out bg-gray-800 border-gray-600 rounded">
                                <label for="chk-internal-single" class="text-xs text-gray-500">Single Internal
                                    Color</label>
                            </div>

                            <div id="div-internal-color"
                                class="flex gap-2 items-center pl-6 opacity-50 pointer-events-none transition-opacity duration-200">
                                <input type="color" id="val-internal-color" value="#222222"
                                    class="h-6 w-6 rounded cursor-pointer bg-transparent border-0 p-0">
                                <input type="text" id="hex-internal-color" value="#222222"
                                    class="w-20 bg-gray-800 border border-gray-600 rounded px-1 py-0.5 text-xs text-gray-300 font-mono uppercase">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Optimization (Generation) -->
                <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-sm font-bold text-gray-400 uppercase mb-3">6. Optimization</h2>
                    <p class="text-[10px] text-gray-500 mb-3">Generate pre-cut assets for instant loading and correct
                        inner colors.</p>

                    <div class="space-y-2">
                        <button id="btn-generate"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition text-xs">
                            ‚öôÔ∏è Generate Cubies
                        </button>
                        <div id="gen-progress" class="hidden text-xs text-center text-blue-400 font-mono">
                            Processing: <span id="gen-count">0</span> / <span id="gen-total">0</span>
                        </div>
                        <button id="btn-export-binary"
                            class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded transition text-xs disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                            üíæ Export Binary Assets
                        </button>

                        <button id="btn-view-exploded"
                            class="hidden w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-1 px-4 mt-2 rounded transition text-xs">
                            üí• View All (Exploded)
                        </button>

                        <!-- Cubie List -->
                        <div id="cubie-list" class="max-h-40 overflow-y-auto mt-2 space-y-1 pr-1 hidden">
                            <!-- Items inserted by JS -->
                        </div>
                    </div>
                </div>

            </div>

        </aside>

        <!-- 3D Viewport -->
        <main class="flex-1 relative bg-black" id="canvas-container">
            <div id="loading-overlay" class="hidden absolute inset-0 flex items-center justify-center bg-black/50 z-20">
                <div class="text-blue-400 font-bold text-xl animate-pulse">Processing...</div>
            </div>

            <!-- Preview Controls -->
            <button id="btn-exit-preview"
                class="hidden absolute top-4 right-4 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded shadow-lg z-10 text-sm">
                Exit Preview
            </button>

            <!-- Instructions Overlay -->
            <div class="absolute bottom-4 left-4 text-xs text-gray-500 pointer-events-none select-none">
                <p><strong>L-Click:</strong> Paint | <strong>R-Click:</strong> Rotate | <strong>Mid/Shift:</strong> Pan
                    | <strong>Scroll:</strong> Zoom</p>
            </div>
        </main>
    </div>

    <!-- Script that powers this page -->
    <script type="module" src="js/tools/StlManager.js"></script>
</body>

</html>